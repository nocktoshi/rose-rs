name: WASM Build

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@1.85.0
      with:
        targets: wasm32-unknown-unknown

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install wasm-pack
      run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

    - name: Install protoc
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Build WASM
      run: make wasm

    - name: Set nightly/build version (non-main branches)
      if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
      working-directory: crates/rose-wasm/pkg
      run: |
        node - <<'NODE'
        const fs = require('fs');
        const path = require('path');
        const pkgPath = path.join(process.cwd(), 'package.json');
        const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
        const sha = (process.env.GITHUB_SHA || '').slice(0, 7);
        const run = process.env.GITHUB_RUN_NUMBER || '0';
        // npm semver: prerelease is allowed; build metadata is ignored by npm, so keep it minimal.
        pkg.version = `${pkg.version}-nightly.${run}.${sha}`;
        fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
        console.log('nightly version set to', pkg.version);
        NODE

    - name: Validate npm package
      run: make npm-pack
